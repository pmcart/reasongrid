generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Organization ---

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                 User[]
  employees             Employee[]
  importJobs            ImportJob[]
  riskRuns              RiskRun[]
  rationaleDefinitions  RationaleDefinition[]
  aiRiskReports         AiRiskReport[]
  policyRules           PolicyRule[]
}

// --- Auth ---

enum UserRole {
  SUPER_ADMIN
  ADMIN
  HR_MANAGER
  MANAGER
  VIEWER
}

model User {
  id             String       @id @default(uuid())
  email          String       @unique
  passwordHash   String
  role           UserRole     @default(VIEWER)
  organizationId String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization      Organization?  @relation(fields: [organizationId], references: [id])
  importJobs        ImportJob[]
  ownedDecisions    PayDecision[] @relation("DecisionOwner")
  approvedDecisions PayDecision[] @relation("DecisionApprover")
}

// --- Employees ---

model Employee {
  id                String   @id @default(uuid())
  employeeId        String
  roleTitle         String
  jobFamily         String?
  level             String
  country           String
  location          String?
  currency          String
  baseSalary        Float
  bonusTarget       Float?
  ltiTarget         Float?
  hireDate          DateTime?
  employmentType    String?
  gender            String?
  performanceRating String?
  organizationId    String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  payDecisions PayDecision[]
  snapshots    EmployeeSnapshot[]

  @@unique([organizationId, employeeId])
  @@index([organizationId])
  @@index([country, jobFamily, level])
}

// --- Pay Decisions ---

enum DecisionType {
  NEW_HIRE
  PROMOTION
  ADJUSTMENT
  ANNUAL_INCREASE
  OTHER
}

enum DecisionStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  RETURNED
  FINALISED
}

model PayDecision {
  id                     String         @id @default(uuid())
  employeeId             String
  decisionType           DecisionType
  effectiveDate          DateTime
  payBeforeBase          Float
  payAfterBase           Float
  payBeforeBonus         Float?
  payAfterBonus          Float?
  payBeforeLti           Float?
  payAfterLti            Float?
  supportingContext       String
  evidenceReference      String?
  status                 DecisionStatus @default(DRAFT)
  accountableOwnerUserId String
  approverUserId         String
  finalisedAt            DateTime?
  evaluationSnapshot     Json?
  returnReason           String?
  submittedAt            DateTime?
  approvedAt             DateTime?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  snapshotId             String?

  employee   Employee           @relation(fields: [employeeId], references: [id])
  owner      User               @relation("DecisionOwner", fields: [accountableOwnerUserId], references: [id])
  approver   User               @relation("DecisionApprover", fields: [approverUserId], references: [id])
  snapshot   EmployeeSnapshot?  @relation(fields: [snapshotId], references: [id])
  rationales PayDecisionRationale[]

  @@index([employeeId])
  @@index([status])
  @@index([effectiveDate])
  @@index([snapshotId])
}

// --- Rationale Governance ---

enum RationaleCategory {
  STRUCTURAL
  MARKET
  PERFORMANCE
  TEMPORARY
  OTHER
}

enum RationaleStatus {
  ACTIVE
  ARCHIVED
}

model RationaleDefinition {
  id                       String            @id @default(uuid())
  organizationId           String
  code                     String
  name                     String
  legalDescription         String            @db.Text
  plainLanguageDescription String            @default("") @db.Text
  category                 RationaleCategory
  objectiveCriteriaTags    Json              @default("[]")
  applicableDecisionTypes  Json              @default("[]")
  status                   RationaleStatus   @default(ACTIVE)
  version                  Int               @default(1)
  effectiveFrom            DateTime          @default(now())
  effectiveTo              DateTime?
  jurisdictionScope        Json              @default("[]")
  requiresSubstantiation   Boolean           @default(false)
  createdByUserId          String?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt

  organization            Organization           @relation(fields: [organizationId], references: [id])
  payDecisionRationales   PayDecisionRationale[]

  @@unique([organizationId, code, version])
  @@index([organizationId, status])
  @@index([organizationId, code])
}

model PayDecisionRationale {
  id                    String      @id @default(uuid())
  payDecisionId         String
  rationaleDefinitionId String
  rationaleSnapshot     Json

  payDecision           PayDecision           @relation(fields: [payDecisionId], references: [id], onDelete: Cascade)
  rationaleDefinition   RationaleDefinition   @relation(fields: [rationaleDefinitionId], references: [id])

  @@unique([payDecisionId, rationaleDefinitionId])
}

// --- Imports ---

enum ImportJobStatus {
  PENDING_MAPPING
  PROCESSING
  COMPLETED
  FAILED
}

model ImportJob {
  id               String          @id @default(uuid())
  uploadedByUserId String
  organizationId   String
  status           ImportJobStatus @default(PENDING_MAPPING)
  filePath         String?
  createdCount     Int?
  updatedCount     Int?
  errorCount       Int?
  mappingJson      Json?
  errorReportPath  String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  uploadedBy   User               @relation(fields: [uploadedByUserId], references: [id])
  organization Organization       @relation(fields: [organizationId], references: [id])
  snapshots    EmployeeSnapshot[]
  riskRuns     RiskRun[]
}

// --- Risk Analysis ---

enum RiskRunStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum RiskState {
  WITHIN_EXPECTED_RANGE
  REQUIRES_REVIEW
  THRESHOLD_ALERT
}

model RiskRun {
  id             String        @id @default(uuid())
  triggeredBy    String
  organizationId String
  importJobId    String?
  startedAt      DateTime      @default(now())
  finishedAt     DateTime?
  status         RiskRunStatus @default(RUNNING)

  organization Organization    @relation(fields: [organizationId], references: [id])
  importJob    ImportJob?      @relation(fields: [importJobId], references: [id])
  groups       RiskGroupResult[]
  reports      AiRiskReport[]
}

model AiRiskReport {
  id             String   @id @default(uuid())
  riskRunId      String
  organizationId String
  summary        String   @db.Text
  model          String
  generatedAt    DateTime @default(now())

  riskRun      RiskRun      @relation(fields: [riskRunId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([riskRunId])
}

model RiskGroupResult {
  id                String    @id @default(uuid())
  riskRunId         String
  country           String
  jobFamily         String?
  level             String
  roleTitleFallback String?
  groupKey          String
  womenCount        Int
  menCount          Int
  gapPct            Float
  riskState         RiskState
  notes             String?
  computedAt        DateTime  @default(now())

  riskRun RiskRun @relation(fields: [riskRunId], references: [id], onDelete: Cascade)

  @@index([groupKey])
  @@index([riskState])
  @@index([computedAt])
}

// --- Employee Snapshots ---

model EmployeeSnapshot {
  id                 String   @id @default(uuid())
  employeeId         String
  importJobId        String?
  organizationId     String

  employeeExternalId String
  roleTitle          String
  jobFamily          String?
  level              String
  country            String
  location           String?
  currency           String
  baseSalary         Float
  bonusTarget        Float?
  ltiTarget          Float?
  hireDate           DateTime?
  employmentType     String?
  gender             String?
  performanceRating  String?

  // Computed context fields (populated at pay decision time, null for import snapshots)
  tenureYears            Float?
  compaRatio             Float?
  positionInRange        Float?
  comparatorGroupKey     String?
  priorPromotionCount    Int?
  lastPromotionDate      DateTime?
  priorIncreaseCount     Int?
  priorIncreaseTotalPct  Float?

  snapshotAt         DateTime @default(now())
  createdAt          DateTime @default(now())

  employee     Employee      @relation(fields: [employeeId], references: [id])
  importJob    ImportJob?    @relation(fields: [importJobId], references: [id])
  payDecisions PayDecision[]

  @@index([employeeId, snapshotAt])
  @@index([importJobId])
  @@index([organizationId])
  @@index([comparatorGroupKey])
}

// --- Salary Ranges ---

model SalaryRange {
  id             String   @id @default(uuid())
  organizationId String
  country        String
  jobFamily      String?
  level          String
  currency       String
  min            Float
  mid            Float
  max            Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, country, jobFamily, level])
  @@index([organizationId])
}

// --- Policy Engine ---

enum CheckType {
  GENDER_GAP_IMPACT
  SALARY_RANGE_COMPLIANCE
  MEDIAN_DEVIATION
  HISTORICAL_CONSISTENCY
  CHANGE_MAGNITUDE
}

enum PolicySeverity {
  INFO
  WARNING
  BLOCK
}

model PolicyRule {
  id                    String          @id @default(uuid())
  organizationId        String
  checkType             CheckType
  enabled               Boolean         @default(true)
  params                Json
  severity              PolicySeverity  @default(WARNING)
  appliesToDecisionTypes Json           @default("[]")
  appliesToCountries     Json           @default("[]")
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, checkType])
  @@index([organizationId])
}

// --- Notifications ---

enum NotificationType {
  DECISION_SUBMITTED_FOR_REVIEW
  DECISION_APPROVED
  DECISION_RETURNED
}

model Notification {
  id              String           @id @default(uuid())
  recipientUserId String
  type            NotificationType
  entityType      String
  entityId        String
  message         String
  read            Boolean          @default(false)
  createdAt       DateTime         @default(now())

  @@index([recipientUserId, read])
  @@index([recipientUserId, createdAt])
}

// --- Audit Log ---

enum AuditAction {
  EMPLOYEE_CREATED
  EMPLOYEE_UPDATED
  EMPLOYEE_IMPORTED
  PAY_DECISION_CREATED
  PAY_DECISION_UPDATED
  PAY_DECISION_FINALISED
  PAY_DECISION_SUBMITTED
  PAY_DECISION_APPROVED
  PAY_DECISION_RETURNED
  IMPORT_STARTED
  IMPORT_COMPLETED
  IMPORT_FAILED
  RISK_RUN_TRIGGERED
  RISK_RUN_COMPLETED
  USER_LOGIN
  RATIONALE_CREATED
  RATIONALE_UPDATED
  RATIONALE_ARCHIVED
}

model AuditLog {
  id             String      @id @default(uuid())
  organizationId String?
  userId         String?
  action         AuditAction
  entityType     String
  entityId       String?
  metadata       Json?
  ipAddress      String?
  createdAt      DateTime    @default(now())

  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
}
